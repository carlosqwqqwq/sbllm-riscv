# RISC-V åŠŸèƒ½æµ‹è¯•æ•™ç¨‹

## ğŸ“– ç®€ä»‹

æœ¬æ•™ç¨‹å°†æŒ‡å¯¼ä½ å¦‚ä½•ä½¿ç”¨ `test_riscv.sh` è„šæœ¬å¿«é€Ÿæµ‹è¯• RISC-V ä¼˜åŒ–æ¡†æ¶çš„åŸºæœ¬åŠŸèƒ½ã€‚è¿™ä¸ªæµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ•°æ®ã€è¿è¡Œç¯å¢ƒéªŒè¯ã€æ‰§è¡Œä¸€æ¬¡ç®€åŒ–çš„ä¼˜åŒ–æµç¨‹ï¼Œå¹¶éªŒè¯ç»“æœã€‚

## ğŸ¯ æµ‹è¯•ç›®æ ‡

æµ‹è¯•è„šæœ¬å°†éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š

1. âœ… **ç¯å¢ƒé…ç½®**ï¼šQEMU å’Œ RISC-V GCC å·¥å…·é“¾æ˜¯å¦æ­£ç¡®é…ç½®
2. âœ… **æ•°æ®å‡†å¤‡**ï¼šæµ‹è¯•æ•°æ®å’Œè®­ç»ƒæ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
3. âœ… **ä»£ç ç”Ÿæˆ**ï¼šLLM æ˜¯å¦èƒ½ç”Ÿæˆä¼˜åŒ–å€™é€‰ä»£ç 
4. âœ… **ä»£ç è¯„ä¼°**ï¼šQEMU è¯„ä¼°å™¨æ˜¯å¦èƒ½æ­£ç¡®ç¼–è¯‘å’Œè¿è¡Œä»£ç 
5. âœ… **ç»“æœè¾“å‡º**ï¼šè¯„ä¼°æŠ¥å‘Šæ˜¯å¦æ­£ç¡®ç”Ÿæˆ

## ğŸ“‹ å‰ç½®è¦æ±‚

### 1. ç³»ç»Ÿè¦æ±‚

- Linux ç³»ç»Ÿï¼ˆæ¨è Ubuntu 20.04+ï¼‰
- Python 3.9.12+
- QEMUï¼ˆqemu-riscv64ï¼‰
- RISC-V GCC å·¥å…·é“¾

### 2. å®‰è£…ä¾èµ–

```bash
# å®‰è£… Python ä¾èµ–
cd sbllm
pip install -r requirement.txt

# å®‰è£… QEMUï¼ˆUbuntu/Debianï¼‰
sudo apt-get update
sudo apt-get install qemu-user-riscv64

# éªŒè¯ QEMU å®‰è£…
qemu-riscv64 --version
```

### 3. é…ç½® API å¯†é’¥

ç¼–è¾‘ `sbllm/sbllm/evol_query.py`ï¼Œå¡«å…¥ä½ çš„ API å¯†é’¥ï¼š

```python
# é»˜è®¤ä½¿ç”¨ DeepSeekï¼Œç¡®ä¿é…ç½®æ­¤é¡¹
deepseek_api_keys = [
    "your-deepseek-api-key",
]

# å¯é€‰ï¼šå…¶ä»–æ¨¡å‹çš„ API å¯†é’¥
openai_api_keys = ['your-openai-api-key']
gemini_api_keys = ["your-gemini-api-key"]
# ... å…¶ä»– API å¯†é’¥
```

**é‡è¦**ï¼šæµ‹è¯•è„šæœ¬é»˜è®¤ä½¿ç”¨ `deepseek` æ¨¡å‹ï¼Œå¿…é¡»é…ç½® `deepseek_api_keys`ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1: è¿›å…¥è„šæœ¬ç›®å½•

```bash
cd sbllm/sbllm
```

### æ­¥éª¤ 2: è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
bash test_riscv.sh \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu
```

**æ³¨æ„**ï¼š
- è¯·æ ¹æ®ä½ çš„å®é™…å®‰è£…è·¯å¾„ä¿®æ”¹ `--qemu_path` å’Œ `--riscv_gcc_toolchain_path` å‚æ•°
- æµ‹è¯•è„šæœ¬é»˜è®¤ä½¿ç”¨ `deepseek` æ¨¡å‹ï¼Œç¡®ä¿å·²åœ¨ `evol_query.py` ä¸­é…ç½® DeepSeek API å¯†é’¥

### æ­¥éª¤ 3: æŸ¥çœ‹æµ‹è¯•ç»“æœ

æµ‹è¯•å®Œæˆåï¼ŒæŸ¥çœ‹è¯„ä¼°æŠ¥å‘Šï¼š

```bash
cat test_output_riscv/riscv/riscv_optimization/0/test_execution_0.report
```

## ğŸ“ è¯¦ç»†ä½¿ç”¨è¯´æ˜

### åŸºæœ¬ç”¨æ³•

```bash
bash test_riscv.sh \
    --qemu_path <QEMUè·¯å¾„> \
    --riscv_gcc_toolchain_path <å·¥å…·é“¾è·¯å¾„>
```

### ä½¿ç”¨ä¸åŒæ¨¡å‹

```bash
# é»˜è®¤ä½¿ç”¨ DeepSeekï¼ˆæ— éœ€æŒ‡å®šï¼‰
bash test_riscv.sh \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu

# ä½¿ç”¨ Gemini
bash test_riscv.sh \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu \
    --model_name gemini

# ä½¿ç”¨ GPT-4
bash test_riscv.sh \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu \
    --model_name gpt4

# ä½¿ç”¨ ChatGPT
bash test_riscv.sh \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu \
    --model_name chatgpt
```

### æŸ¥çœ‹å¸®åŠ©

```bash
bash test_riscv.sh --help
```

## ğŸ” æµ‹è¯•æµç¨‹è¯¦è§£

### æ­¥éª¤ 1: ç¯å¢ƒéªŒè¯

æµ‹è¯•è„šæœ¬é¦–å…ˆä¼šè¿è¡Œ `validate_riscv_setup.py` éªŒè¯ç¯å¢ƒé…ç½®ï¼š

- âœ… æ£€æŸ¥ QEMU å¯æ‰§è¡Œæ–‡ä»¶
- âœ… æ£€æŸ¥ RISC-V GCC å·¥å…·é“¾
- âœ… æ£€æŸ¥ Python ä¾èµ–åŒ…
- âœ… æ£€æŸ¥ API å¯†é’¥é…ç½®

**å¦‚æœéªŒè¯å¤±è´¥**ï¼š
- æ£€æŸ¥ QEMU å’Œå·¥å…·é“¾è·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ‰€æœ‰ä¾èµ–å·²å®‰è£…
- æ£€æŸ¥ API å¯†é’¥æ˜¯å¦å·²é…ç½®

### æ­¥éª¤ 2: åˆ›å»ºæµ‹è¯•æ•°æ®

è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹æµ‹è¯•æ•°æ®ï¼š

1. **test.jsonl**ï¼šåŒ…å«ä¸€ä¸ªç®€å•çš„ RISC-V æ±‡ç¼–å‡½æ•°ï¼ˆæ•°ç»„æ±‚å’Œï¼‰
   - åŒ…å«ä»£ç æ³¨é‡Šï¼Œè¯´æ˜ä¼˜åŒ–æ–¹å‘
   - åŒ…å«æµ‹è¯•è¾“å…¥æ•°æ®

2. **train.jsonl**ï¼šç®€åŒ–çš„è®­ç»ƒæ•°æ®ï¼ˆçŸ¥è¯†åº“ï¼‰
   - åŒ…å«ä¸€ä¸ªä¼˜åŒ–ç¤ºä¾‹
   - ç”¨äºæµ‹è¯•çŸ¥è¯†åº“æ£€ç´¢åŠŸèƒ½

**æµ‹è¯•æ•°æ®ä½ç½®**ï¼š`./test_data_riscv/`

### æ­¥éª¤ 3: åˆå§‹åŒ–ç»“æœ

è¿è¡Œ `initial.py` åˆå§‹åŒ–ç»“æœæ–‡ä»¶ç»“æ„ã€‚

### æ­¥éª¤ 4: è¿è¡Œä¼˜åŒ–è¿­ä»£

æ‰§è¡Œä¸€æ¬¡ç®€åŒ–çš„ä¼˜åŒ–æµç¨‹ï¼š

1. **ç”Ÿæˆä¼˜åŒ–å€™é€‰**ï¼ˆ`evol_query.py`ï¼‰
   - åˆ†æä»£ç æ³¨é‡Š
   - ç”Ÿæˆ 3 ä¸ªä¼˜åŒ–å€™é€‰ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰

2. **è¯„ä¼°å€™é€‰ä»£ç **ï¼ˆ`evaluate.py`ï¼‰
   - ä½¿ç”¨ QEMU ç¼–è¯‘å’Œè¿è¡Œä»£ç 
   - è¯„ä¼°åŠŸèƒ½æ­£ç¡®æ€§å’Œæ€§èƒ½

### æ­¥éª¤ 5: éªŒè¯ç»“æœ

æ£€æŸ¥è¯„ä¼°æŠ¥å‘Šæ˜¯å¦æˆåŠŸç”Ÿæˆã€‚

## ğŸ“Š æµ‹è¯•è¾“å‡ºè¯´æ˜

### æˆåŠŸè¾“å‡ºç¤ºä¾‹

```
============================================================
        RISC-V ä¼˜åŒ–æ¡†æ¶åŠŸèƒ½æµ‹è¯•
============================================================

[æ­¥éª¤ 1/5] ç¯å¢ƒéªŒè¯
------------------------------------------------------------
âœ“ QEMU: /usr/bin/qemu-riscv64
âœ“ å·¥å…·é“¾å·¥å…·: riscv64-unknown-linux-gnu-gcc
âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ç¯å¢ƒé…ç½®æ­£ç¡®ã€‚

[æ­¥éª¤ 2/5] åˆ›å»ºæµ‹è¯•æ•°æ®
------------------------------------------------------------
âœ“ æµ‹è¯•æ•°æ®å·²åˆ›å»º
  - æµ‹è¯•æ•°æ®: ./test_data_riscv/test.jsonl
  - è®­ç»ƒæ•°æ®: ./test_data_riscv/train.jsonl

[æ­¥éª¤ 3/5] åˆå§‹åŒ–ç»“æœ
------------------------------------------------------------
...

[æ­¥éª¤ 4/5] è¿è¡Œä¼˜åŒ–è¿­ä»£ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰
------------------------------------------------------------
ç”Ÿæˆä¼˜åŒ–å€™é€‰...
è¯„ä¼°å€™é€‰ä»£ç ...
âœ“ ä¼˜åŒ–è¿­ä»£å®Œæˆ

[æ­¥éª¤ 5/5] éªŒè¯ç»“æœ
------------------------------------------------------------
âœ“ æ‰¾åˆ°è¯„ä¼°æŠ¥å‘Š
âœ“ æµ‹è¯•å®Œæˆï¼
```

### è¾“å‡ºæ–‡ä»¶ç»“æ„

```
test_output_riscv/
â””â”€â”€ riscv/
    â””â”€â”€ riscv_optimization/
        â””â”€â”€ 0/
            â”œâ”€â”€ prediction_0.jsonl      # ç”Ÿæˆçš„å€™é€‰ä»£ç 
            â””â”€â”€ test_execution_0.report # è¯„ä¼°æŠ¥å‘Š
```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1: ç¯å¢ƒéªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âœ— QEMU: /usr/bin/qemu-riscv64 (æ–‡ä»¶ä¸å­˜åœ¨)
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ QEMU æ˜¯å¦å®‰è£…
which qemu-riscv64

# å¦‚æœæœªå®‰è£…ï¼Œå®‰è£… QEMU
sudo apt-get install qemu-user-riscv64

# ä½¿ç”¨å®é™…è·¯å¾„
bash test_riscv.sh \
    --qemu_path $(which qemu-riscv64) \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu
```

### é—®é¢˜ 2: API å¯†é’¥æœªé…ç½®

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âš  æ£€æµ‹åˆ°å ä½ç¬¦ API å¯†é’¥
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¼–è¾‘ `sbllm/sbllm/evol_query.py`
2. æ›¿æ¢å ä½ç¬¦ API å¯†é’¥ä¸ºçœŸå®å¯†é’¥
3. é‡æ–°è¿è¡Œæµ‹è¯•

### é—®é¢˜ 3: ä»£ç ç”Ÿæˆå¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ç”Ÿæˆå€™é€‰å¤±è´¥
```

**å¯èƒ½åŸå› **ï¼š
- API å¯†é’¥æ— æ•ˆæˆ–é…é¢ä¸è¶³
- ç½‘ç»œè¿æ¥é—®é¢˜
- LLM æœåŠ¡ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æœ‰æ•ˆï¼ˆé»˜è®¤ä½¿ç”¨ DeepSeekï¼Œç¡®ä¿ `deepseek_api_keys` å·²é…ç½®ï¼‰
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹ï¼ˆ`--model_name gemini` æˆ– `--model_name chatgpt`ï¼‰

### é—®é¢˜ 4: ç¼–è¯‘å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Assembly failed: error: invalid instruction
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æµ‹è¯•æ•°æ®ä¸­çš„ä»£ç æ ¼å¼
- ç¡®è®¤æ˜¯æœ‰æ•ˆçš„ RISC-V æ±‡ç¼–ä»£ç 
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

### é—®é¢˜ 5: è¯„ä¼°æŠ¥å‘Šæœªç”Ÿæˆ

**å¯èƒ½åŸå› **ï¼š
- è¯„ä¼°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯
- è¾“å‡ºç›®å½•æƒé™é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥è¾“å‡ºç›®å½•æƒé™
ls -la test_output_riscv/

# æ‰‹åŠ¨æ£€æŸ¥è¯„ä¼°æ—¥å¿—
cat test_output_riscv/riscv/riscv_optimization/0/*.log
```

## ğŸ“ˆ æµ‹è¯•ç»“æœè§£è¯»

### è¯„ä¼°æŠ¥å‘Šæ ¼å¼

è¯„ä¼°æŠ¥å‘Šï¼ˆ`test_execution_*.report`ï¼‰åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

```json
{
    "code_v0_no_empty_lines": "åŸå§‹ä»£ç ",
    "input_time_mean": 1.23,
    "model_generated_potentially_faster_code_col_0": "å€™é€‰ä»£ç  0",
    "model_generated_potentially_faster_code_col_0_acc": 1,
    "model_generated_potentially_faster_code_col_0_time_mean": 0.85
}
```

### å…³é”®æŒ‡æ ‡

- **acc**ï¼šåŠŸèƒ½æ­£ç¡®æ€§ï¼ˆ1 = æ­£ç¡®ï¼Œ0 = é”™è¯¯ï¼‰
- **time_mean**ï¼šå¹³å‡æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
- **speedup_ratio**ï¼šåŠ é€Ÿæ¯”ï¼ˆæ­£å€¼è¡¨ç¤ºæ€§èƒ½æå‡ï¼‰

### æˆåŠŸæ ‡å‡†

æµ‹è¯•æˆåŠŸçš„æ ‡å‡†ï¼š
- âœ… è‡³å°‘ç”Ÿæˆ 1 ä¸ªå€™é€‰ä»£ç 
- âœ… è‡³å°‘ 1 ä¸ªå€™é€‰ä»£ç åŠŸèƒ½æ­£ç¡®ï¼ˆacc = 1ï¼‰
- âœ… è¯„ä¼°æŠ¥å‘ŠæˆåŠŸç”Ÿæˆ

## ğŸ“ è¿›é˜¶ä½¿ç”¨

### è‡ªå®šä¹‰æµ‹è¯•æ•°æ®

ä½ å¯ä»¥ä¿®æ”¹ `test_riscv.sh` ä¸­çš„æµ‹è¯•æ•°æ®ï¼Œä½¿ç”¨ä½ è‡ªå·±çš„ RISC-V ä»£ç ï¼š

```bash
# ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹æµ‹è¯•æ•°æ®éƒ¨åˆ†
vim test_riscv.sh
```

### è¿è¡Œå®Œæ•´æµ‹è¯•

æµ‹è¯•è„šæœ¬åªè¿è¡Œä¸€æ¬¡è¿­ä»£ã€‚è¦è¿è¡Œå®Œæ•´çš„ä¼˜åŒ–æµç¨‹ï¼Œä½¿ç”¨ï¼š

```bash
bash run_riscv.sh \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu
```

### è°ƒè¯•æ¨¡å¼

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨è¿è¡Œå„ä¸ªæ­¥éª¤è¿›è¡Œè°ƒè¯•ï¼š

```bash
# 1. ç¯å¢ƒéªŒè¯
python3 validate_riscv_setup.py \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu

# 2. ç”Ÿæˆå€™é€‰
python3 evol_query.py \
    --mode riscv_optimization \
    --model_name chatgpt \
    --lang riscv \
    --generation_path ../test_output_riscv \
    --baseline_data_path test_data_riscv/test.jsonl \
    --iteration 0 \
    --generation_number 3 \
    --riscv_mode

# 3. è¯„ä¼°
python3 evaluate.py \
    --mode riscv_optimization \
    --lang riscv \
    --output_path ../test_output_riscv/riscv \
    --model_name chatgpt \
    --qemu_path /usr/bin/qemu-riscv64 \
    --riscv_gcc_toolchain_path /opt/riscv64-unknown-linux-gnu \
    --test_case_path test_data_riscv/test_cases \
    --process_number 2 \
    --riscv_mode
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®Œæ•´ä½¿ç”¨æ‰‹å†Œ**ï¼š`README-RISCV.md`
- **ç¯å¢ƒéªŒè¯è„šæœ¬**ï¼š`validate_riscv_setup.py`
- **å®Œæ•´è¿è¡Œè„šæœ¬**ï¼š`run_riscv.sh`

## ğŸ’¡ æç¤º

1. **é¦–æ¬¡è¿è¡Œ**ï¼šå»ºè®®å…ˆè¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ç¯å¢ƒé…ç½®
2. **å¿«é€ŸéªŒè¯**ï¼šæµ‹è¯•è„šæœ¬ä½¿ç”¨ç®€åŒ–çš„é…ç½®ï¼Œè¿è¡Œæ—¶é—´çº¦ 2-5 åˆ†é’Ÿ
3. **ç”Ÿäº§ä½¿ç”¨**ï¼šæµ‹è¯•é€šè¿‡åï¼Œä½¿ç”¨ `run_riscv.sh` è¿›è¡Œå®Œæ•´çš„ä¼˜åŒ–æµç¨‹
4. **æ¨¡å‹é€‰æ‹©**ï¼šå¦‚æœæŸä¸ªæ¨¡å‹å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹ï¼ˆ`--model_name gemini`ï¼‰

## â“ å¸¸è§é—®é¢˜

**Q: æµ‹è¯•è„šæœ¬è¿è¡Œå¤šé•¿æ—¶é—´ï¼Ÿ**
A: é€šå¸¸ 2-5 åˆ†é’Ÿï¼Œå–å†³äº LLM API å“åº”é€Ÿåº¦å’Œç³»ç»Ÿæ€§èƒ½ã€‚

**Q: æµ‹è¯•æ•°æ®ä¼šè¢«ä¿å­˜å—ï¼Ÿ**
A: æ˜¯çš„ï¼Œæµ‹è¯•æ•°æ®ä¿å­˜åœ¨ `test_data_riscv/` ç›®å½•ï¼Œè¾“å‡ºä¿å­˜åœ¨ `test_output_riscv/` ç›®å½•ã€‚

**Q: å¯ä»¥åˆ é™¤æµ‹è¯•æ•°æ®å—ï¼Ÿ**
A: å¯ä»¥ï¼Œæµ‹è¯•æ•°æ®ä¼šåœ¨æ¯æ¬¡è¿è¡Œæ—¶é‡æ–°åˆ›å»ºã€‚

**Q: æµ‹è¯•å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**
A: æŸ¥çœ‹é”™è¯¯ä¿¡æ¯ï¼Œå‚è€ƒæ•…éšœæ’é™¤éƒ¨åˆ†ï¼Œæˆ–æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚

---

**ç¥ä½ æµ‹è¯•é¡ºåˆ©ï¼** ğŸ‰

